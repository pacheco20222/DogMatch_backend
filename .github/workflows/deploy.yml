name: Deploy Backend to Azure Container Apps

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP: dogmatch-app
  AZURE_CONTAINERAPPS_ENVIRONMENT: dogmatch-env
  AZURE_CONTAINER_REGISTRY_LOGIN_SERVER: dogmtachcr.azurecr.io
  CONTAINER_APP_NAME: dogmatch-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Login to Azure (OIDC)
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Azure CLI - Log in to ACR
      run: |
        az acr login --name dogmtachcr

    - name: Build Docker image
      run: |
        IMAGE_TAG=${{ env.AZURE_CONTAINER_REGISTRY_LOGIN_SERVER }}/dogmatch-backend:${{ github.sha }}
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        docker build -t $IMAGE_TAG .

    - name: Push Docker image
      run: |
        docker push $IMAGE_TAG

    - name: Deploy to Azure Container Apps
      run: |
        # First, update the image and basic configuration
        az containerapp update \
          --name $CONTAINER_APP_NAME \
          --resource-group $AZURE_RESOURCE_GROUP \
          --image $IMAGE_TAG \
          --set properties.configuration.ingress.external=true \
          --set properties.configuration.ingress.targetPort=5002 \
          --set-env-vars \
            FLASK_ENV=production \
            DATABASE_URL=${{ secrets.DATABASE_URL }} \
            REDIS_URL=${{ secrets.REDIS_URL }} \
            SECRET_KEY="${{ secrets.SECRET_KEY }}" \
            JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
            AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
            AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
            AWS_DEFAULT_REGION="${{ secrets.AWS_DEFAULT_REGION }}" \
            S3_BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}" \
            GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
            JWT_ACCESS_TOKEN_EXPIRES="${{ secrets.JWT_ACCESS_TOKEN_EXPIRES }}" \
            JWT_REFRESH_TOKEN_EXPIRES="${{ secrets.JWT_REFRESH_TOKEN_EXPIRES }}"
        
        # Configure probes - using individual --set commands for reliability
        az containerapp update \
          --name $CONTAINER_APP_NAME \
          --resource-group $AZURE_RESOURCE_GROUP \
          --set properties.template.containers[0].probes[0].type=Startup \
          --set properties.template.containers[0].probes[0].httpGet.path=/api/health/live \
          --set properties.template.containers[0].probes[0].httpGet.port=5002 \
          --set properties.template.containers[0].probes[0].httpGet.scheme=HTTP \
          --set properties.template.containers[0].probes[0].initialDelaySeconds=10 \
          --set properties.template.containers[0].probes[0].periodSeconds=5 \
          --set properties.template.containers[0].probes[0].timeoutSeconds=3 \
          --set properties.template.containers[0].probes[0].failureThreshold=30 \
          --set properties.template.containers[0].probes[0].successThreshold=1 \
          --set properties.template.containers[0].probes[1].type=Liveness \
          --set properties.template.containers[0].probes[1].httpGet.path=/api/health/live \
          --set properties.template.containers[0].probes[1].httpGet.port=5002 \
          --set properties.template.containers[0].probes[1].httpGet.scheme=HTTP \
          --set properties.template.containers[0].probes[1].initialDelaySeconds=30 \
          --set properties.template.containers[0].probes[1].periodSeconds=10 \
          --set properties.template.containers[0].probes[1].timeoutSeconds=5 \
          --set properties.template.containers[0].probes[1].failureThreshold=3 \
          --set properties.template.containers[0].probes[1].successThreshold=1 \
          --set properties.template.containers[0].probes[2].type=Readiness \
          --set properties.template.containers[0].probes[2].httpGet.path=/api/health/ready \
          --set properties.template.containers[0].probes[2].httpGet.port=5002 \
          --set properties.template.containers[0].probes[2].httpGet.scheme=HTTP \
          --set properties.template.containers[0].probes[2].initialDelaySeconds=10 \
          --set properties.template.containers[0].probes[2].periodSeconds=5 \
          --set properties.template.containers[0].probes[2].timeoutSeconds=3 \
          --set properties.template.containers[0].probes[2].failureThreshold=3 \
          --set properties.template.containers[0].probes[2].successThreshold=1 